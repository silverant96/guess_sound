{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Угадай звук</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon.png">
    <link rel="stylesheet" href="{% static 'play_style.css' %}">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-container">
                <img src="/static/logo1.png" alt="Логотип" class="logo">
                <h2>Угадай звук</h2>
            </div>
            <form action="{% url 'logout' %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="logout-link">Выйти</button>
            </form>
        </div>
    </header>

    <div class="game-container">
        {% if show_start %}
            <div class="start-screen">
                <h2>Добро пожаловать в игру "Угадай звук"!</h2>
                <p>Послушайте звук и выберите, какое животное его издаёт.</p>
                <form method="post">
                    {% csrf_token %}
                    <button type="submit" class="start-button">Начать игру</button>
                </form>
            </div>
        {% elif error %}
            <p>{{ error }}</p>
        {% else %}
            <!-- Прогресс -->
            <div class="progress">
                Вопрос {{ progress.current }} из {{ progress.total }}
            </div>

            <audio id="sound" src="{{ sound.sound.url }}" preload="auto"></audio>

            <div class="controls">
                <button type="button" class="sound-button" onclick="document.getElementById('sound').play()">
                    Слушать звук
                </button>
            </div>

            <div class="image-grid">
                {% for item in choices %}
                    <div class="image-choice" onclick="checkAnswer('{{ item.name }}', '{{ sound.name }}')">
                        <img src="{{ item.image.url }}" alt="{{ item.name }}" class="animal-image">
                        <p class="animal-name">{{ item.name }}</p>
                    </div>
                {% endfor %}
            </div>

            {% if correct_feedback_audio %}
                <audio id="correct-sound" src="{{ correct_feedback_audio }}"></audio>
            {% endif %}
            {% if wrong_feedback_audio %}
                <audio id="wrong-sound" src="{{ wrong_feedback_audio }}"></audio>
            {% endif %}
        {% endif %}
    </div>

    <footer class="footer">
        <p>&copy; 2025 Угадай звук — Образовательная игра для изучения звуков животных.</p>
    </footer>

    <script>
function checkAnswer(selected, correct) {
    const correctAudio = document.getElementById('correct-sound');
    const wrongAudio = document.getElementById('wrong-sound');

    fetch('{% url "game:check_answer" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ selected, correct })
    })
    .then(response => response.json())
    .then(data => {
    if (data.correct) {
        if (correctAudio) correctAudio.play();
        alert('Правильно! Это ' + correct);
    } else {
        if (wrongAudio) {
            const playPromise = wrongAudio.play();
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        alert('Неправильно! Это был ' + correct + '. Следующий звук!');
                    })
                    .catch(() => {
                        alert('Неправильно! Это был ' + correct + '. Следующий звук!');
                    });
            }
        } else {
            alert('Неправильно! Это был ' + correct + '. Следующий звук!');
        }
    }

    // ВСЕГДА перезагружаем, чтобы показать следующий вопрос
    setTimeout(() => {
        location.reload();
    }, 1000);
    })
    .catch(err => {
        console.error('Ошибка:', err);
        alert('Произошла ошибка. Попробуйте ещё раз.');
    });
}
</script>
</body>
</html>